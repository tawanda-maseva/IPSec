// Clean the lab
configure
delete security
delete interfaces ge-0/0/1 unit 0 family inet address 10.100.12.1/24
delete interfaces st0 unit 0 family inet address 10.100.200.1/24

///////////////////////////////////////////// Configuration ///////////////////////////////////


// Configure interface, static route, and security zone information:
set interfaces ge-0/0/1 unit 0 family inet address 172.32.13.1/30
set interfaces ge-0/0/1 description To_ISP
set interfaces st0 unit 0 family inet address 10.100.200.1/30
set interfaces st0 description To_oobhr01.st0
set interfaces lo0 unit 0 family inet address 10.100.100.1/32

set routing-options static route 0.0.0.0/0 next-hop 172.32.13.2

set security zones security-zone internet interfaces ge-0/0/1.0
set security zones security-zone internet host-inbound-traffic system-services ike
set security zones security-zone internet host-inbound-traffic system-services ping
set security zones security-zone VPN interfaces st0.0
set security zones security-zone VPN interfaces lo0.0
set security zones security-zone VPN host-inbound-traffic system-services ping
set security zones security-zone VPN host-inbound-traffic system-services ssh
set security zones security-zone VPN host-inbound-traffic protocols bgp


// Configure IKE:
set security ike proposal standard authentication-method pre-shared-keys
set security ike policy IKE-POL mode main
set security ike policy IKE-POL proposals standard
set security ike policy IKE-POL pre-shared-key ascii-text $ABC123
set security ike gateway IKE-GW ike-policy IKE-POL
set security ike gateway IKE-GW address 172.32.13.2
set security ike gateway IKE-GW external-interface ge-0/0/1


// Configure IPSec:
set security ipsec proposal standard
set security ipsec policy IPSEC-POL proposals standard
set security ipsec vpn VPN-to-Host2 ike gateway IKE-GW
set security ipsec vpn VPN-to-Host2 ike ipsec-policy IPSEC-POL
set security ipsec vpn VPN-to-Host2 bind-interface st0.0
set security ipsec vpn VPN-to-Host2 establish-tunnels immediately


// Configure TCP MSS:
set security flow tcp-mss ipsec-vpn mss 1350

// VPN Traffic routing
set routing-options static route 10.100.22.0/24 next-hop st0.0
set routing-options static route 10.100.100.0/24 next-hop st0.0

// Host-specific Configs:
set interfaces ge-0/0/0 unit 0 family inet address 10.100.11.1/24
set interfaces ge-0/0/0 description To_Host01.
set security zones security-zone trust interfaces ge-0/0/0.0
set security zones security-zone trust host-inbound-traffic system-services all


// Configure the security policies:
set security address-book Host1 address Host1-Net 10.100.11.0/24
set security address-book Host1 attach zone trust
set security address-book Host2 address Host2-Net 10.100.22.0/24
set security address-book Host2 attach zone VPN

set security policies from-zone trust to-zone internet policy default-permit match source-address any
set security policies from-zone trust to-zone internet policy default-permit match destination-address any
set security policies from-zone trust to-zone internet policy default-permit match application any
set security policies from-zone trust to-zone internet policy default-permit then permit

set security policies from-zone trust to-zone VPN policy VPN-OUT match source-address Host1-Net
set security policies from-zone trust to-zone VPN policy VPN-OUT match destination-address any
set security policies from-zone trust to-zone VPN policy VPN-OUT match application any
set security policies from-zone trust to-zone VPN policy VPN-OUT then permit

set security policies from-zone VPN to-zone trust policy VPN-IN match source-address any
set security policies from-zone VPN to-zone trust policy VPN-IN match destination-address Host1-Net
set security policies from-zone VPN to-zone trust policy VPN-IN match application any
set security policies from-zone VPN to-zone trust policy VPN-IN then permit

set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match source-address any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match destination-address any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match application any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any then permit
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any then log session-init


///////////////////////////////////////////// Verification ///////////////////////////////////

// The IKE peering is active
jcluser@vSRX1> show security ike active-peer 
	Remote Address           Port     Peer IKE-ID          AAA username                     Assigned IP
	172.32.13.2              500      172.32.13.2                 not available             0.0.0.0   

// IPSec Tunnel is Active
jcluser@vSRX1> show security ipsec security-associations 
  Total active tunnels: 1     Total Ipsec sas: 1
  ID    Algorithm       SPI      Life:sec/kb  Mon lsys Port  Gateway   
  <131073 ESP:3des/sha1   26f4fd8f 2717/ unlim  -   root 500   10.100.12.2     
  >131073 ESP:3des/sha1   4a139b50 2717/ unlim  -   root 500   10.100.12.2  

// IKE is UP
jcluser@vSRX1> show security ike security-associations
	Index   State  Initiator cookie  Responder cookie  Mode           Remote Address   
	2747280 UP     3c81f453fe48debb  b5d3081cc4c21a3d  Main           10.100.12.2   


// ESP Statistics increment when hosts ping each other over the IPSec Tunnel
	jcluser@vSRX1> show security ipsec statistics    
	ESP Statistics:
	  Encrypted bytes:           925888
	  Decrypted bytes:           570192
	  Encrypted packets:           6808
	  Decrypted packets:           6788
	AH Statistics:
	  Input bytes:                    0
	  Output bytes:                   0
	  Input packets:                  0
	  Output packets:                 0
	Errors:
	  AH authentication failures: 0, Replay errors: 0
	  ESP authentication failures: 0, ESP decryption failures: 0
	  Bad headers: 0, Bad trailers: 0	

	jcluser@vSRX1> 


// Session is created for the HOST1 <> HOST2 ping session. Allowed by VPN-OUT policy
jcluser@vSRX1> show security flow session    
	Session ID: 7, Policy name: N/A, State: Stand-alone, Timeout: N/A, Valid
	  In: 172.32.13.2/0 --> 172.32.13.1/0;esp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 0, Bytes: 0, 	

	Session ID: 83, Policy name: N/A, State: Stand-alone, Timeout: N/A, Valid
	  In: 172.32.13.2/28952 --> 172.32.13.1/57591;esp, Conn Tag: 0x0, If: ge-0/0/1.0, Pkts: 44, Bytes: 5840, 	

	Session ID: 128, Policy name: VPN-OUT/5, State: Stand-alone, Timeout: 2, Valid
	  In: 10.100.11.2/18480 --> 10.100.22.2/35;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84, 
	  Out: 10.100.22.2/35 --> 10.100.11.2/18480;icmp, Conn Tag: 0x0, If: st0.0, Pkts: 1, Bytes: 84, 	

	Session ID: 129, Policy name: VPN-OUT/5, State: Stand-alone, Timeout: 2, Valid
	  In: 10.100.11.2/18480 --> 10.100.22.2/36;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84, 
	  Out: 10.100.22.2/36 --> 10.100.11.2/18480;icmp, Conn Tag: 0x0, If: st0.0, Pkts: 1, Bytes: 84, 	

	Session ID: 130, Policy name: VPN-OUT/5, State: Stand-alone, Timeout: 4, Valid
	  In: 10.100.11.2/18480 --> 10.100.22.2/37;icmp, Conn Tag: 0x0, If: ge-0/0/0.0, Pkts: 1, Bytes: 84, 
	  Out: 10.100.22.2/37 --> 10.100.11.2/18480;icmp, Conn Tag: 0x0, If: st0.0, Pkts: 1, Bytes: 84, 
	Total sessions: 5
