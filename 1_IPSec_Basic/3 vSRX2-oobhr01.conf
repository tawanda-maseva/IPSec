// Clean the lab
config
delete security
delete interfaces ge-0/0/1 unit 0 family inet address 10.100.12.2/24
delete interfaces st0 unit 0 family inet address 10.100.200.2/24

///////////////////////////////////////////// Configuration ///////////////////////////////////

// IPSec Tunnel configs to remote site over Public internet
set interfaces ge-0/0/1 unit 0 family inet address 172.32.13.2/30
set interfaces ge-0/0/1 description To_ISP
set interfaces st0 unit 0 family inet address 10.100.200.2/30
set interfaces st0 description To_oobsr01.st0
set interfaces lo0 unit 0 family inet address 10.100.100.2/32

set routing-options static route 0.0.0.0/0 next-hop 172.32.13.1

set security zones security-zone internet interfaces ge-0/0/1.0
set security zones security-zone internet host-inbound-traffic system-services ike
set security zones security-zone internet host-inbound-traffic system-services ping
set security zones security-zone VPN interfaces st0.0
set security zones security-zone VPN interfaces lo0.0
set security zones security-zone VPN host-inbound-traffic system-services ping
set security zones security-zone VPN host-inbound-traffic protocols bgp

// IKE and IPSec:
set security ike respond-bad-spi 1
set security ike proposal standard authentication-method pre-shared-keys
set security ike proposal pre-g14-sha256-aes authentication-method pre-shared-keys
set security ike proposal pre-g14-sha256-aes dh-group group14
set security ike proposal pre-g14-sha256-aes authentication-algorithm sha-256
set security ike proposal pre-g14-sha256-aes encryption-algorithm aes-256-cbc
set security ike policy oobsr01-ike-policy mode main
set security ike policy oobsr01-ike-policy proposals pre-g14-sha256-aes
set security ike policy oobsr01-ike-policy pre-shared-key ascii-text $ABC123
set security ike gateway oobsr01-ike-gateway ike-policy oobsr01-ike-policy
set security ike gateway oobsr01-ike-gateway address 172.32.13.1
set security ike gateway oobsr01-ike-gateway dead-peer-detection interval 10
set security ike gateway oobsr01-ike-gateway dead-peer-detection threshold 3
set security ike gateway oobsr01-ike-gateway external-interface ge-0/0/1
set security ike gateway oobsr01-ike-gateway version v2-only
set security ipsec proposal nopfs-esp-aes256-sha256 protocol esp
set security ipsec proposal nopfs-esp-aes256-sha256 authentication-algorithm hmac-sha-256-128
set security ipsec proposal nopfs-esp-aes256-sha256 encryption-algorithm aes-256-cbc
set security ipsec policy dcn-ipsec-policy perfect-forward-secrecy keys group14
set security ipsec policy dcn-ipsec-policy proposals nopfs-esp-aes256-sha256
set security ipsec vpn oobsr01-ipsec-vpn ike gateway oobsr01-ike-gateway
set security ipsec vpn oobsr01-ipsec-vpn ike ipsec-policy dcn-ipsec-policy
set security ipsec vpn oobsr01-ipsec-vpn bind-interface st0.0
set security ipsec vpn oobsr01-ipsec-vpn establish-tunnels immediately
set security flow tcp-mss ipsec-vpn mss 1300

// VPN Traffic Routing: Static Routes
set routing-options static route 10.100.11.0/24 next-hop st0.0 preference 200
set routing-options static route 10.100.100.0/24 next-hop st0.0 preference 200

// Host specific configs:
set interfaces ge-0/0/0 unit 0 family inet address 10.100.22.1/24
set interfaces ge-0/0/0 description To_Host2
set security zones security-zone trust host-inbound-traffic system-services all
set security zones security-zone trust interfaces ge-0/0/0.0

// Interzone communication policies:
set security address-book Host1 address Host1-Net 10.100.11.0/24
set security address-book Host1 attach zone VPN
set security address-book Host2 address Host2-Net 10.100.22.0/24
set security address-book Host2 attach zone trust
set security policies from-zone trust to-zone internet policy default-permit match source-address any
set security policies from-zone trust to-zone internet policy default-permit match destination-address any
set security policies from-zone trust to-zone internet policy default-permit match application any
set security policies from-zone trust to-zone internet policy default-permit then permit

set security policies from-zone trust to-zone VPN policy VPN-OUT match source-address Host2-Net
set security policies from-zone trust to-zone VPN policy VPN-OUT match destination-address any
set security policies from-zone trust to-zone VPN policy VPN-OUT match application any
set security policies from-zone trust to-zone VPN policy VPN-OUT then permit

set security policies from-zone VPN to-zone trust policy VPN-IN match source-address any
set security policies from-zone VPN to-zone trust policy VPN-IN match destination-address Host2-Net
set security policies from-zone VPN to-zone trust policy VPN-IN match application any
set security policies from-zone VPN to-zone trust policy VPN-IN then permit

set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match source-address any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match destination-address any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any match application any
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any then permit
set security policies from-zone VPN to-zone VPN policy vpn-to-vpn-any then log session-init

// SNAT:
set security nat source rule-set SNAT from zone trust
set security nat source rule-set SNAT to zone internet
set security nat source rule-set SNAT rule trust-to-internet match source-address 10.0.0.0/8
set security nat source rule-set SNAT rule trust-to-internet match destination-address 0.0.0.0/0
set security nat source rule-set SNAT rule trust-to-internet then source-nat interface


////////////////////////////////////// VPN Traffic routing: BGP /////////////////////////////////

set policy-options policy-statement OOBSRv4-OUT term allow-Host1 from route-filter 10.100.22.0/24 orlonger
set policy-options policy-statement OOBSRv4-OUT term allow-Host1 then next-hop self
set policy-options policy-statement OOBSRv4-OUT term allow-Host1 then accept
set policy-options policy-statement OOBSRv4-OUT term allow-lo0 from route-filter 10.100.100.0/24 prefix-length-range /32-/32
set policy-options policy-statement OOBSRv4-OUT term allow-lo0 then next-hop self
set policy-options policy-statement OOBSRv4-OUT term allow-lo0 then accept
set policy-options policy-statement ACCEPT then accept

set routing-options router-id 10.100.100.2
set routing-options autonomous-system 65004
set protocols bgp hold-time 30
set protocols bgp group OOBHR-v4 type internal
set protocols bgp group OOBHR-v4 family inet unicast
set protocols bgp group OOBHR-v4 peer-as 65004
set protocols bgp group OOBHR-v4 neighbor 10.100.200.1 description oobsr01.st0
set protocols bgp group OOBHR-v4 export OOBSRv4-OUT
set protocols bgp group OOBHR-v4 import ACCEPT

///////////////////////////////////////////// Verification ///////////////////////////////////

// Host1 prefix is received via BGP.
jcluser@vSRX2> show route 10.100.11.0/24
	inet.0: 13 destinations, 15 routes (13 active, 0 holddown, 0 hidden)
	+ = Active Route, - = Last Active, * = Both	

	10.100.11.0/24     *[BGP/170] 00:33:45, localpref 100
	                      AS path: I, validation-state: unverified
	                    >  to 10.100.200.1 via st0.0
	                    [Static/200] 00:34:46
	                    >  via st0.0

jcluser@vSRX2> show security ike active-peer 
	Remote Address      Port     Peer IKE-ID                         AAA username                Assigned IP
	172.32.13.1          500      172.32.13.1                        not available        		  0.0.0.0                          

// BGP Peering Up 
jcluser@vSRX2> show bgp summary 
	Threading mode: BGP I/O
	Default eBGP mode: advertise - accept, receive - accept
	Groups: 1 Peers: 1 Down peers: 0
	Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
	inet.0               
	                       2          2          0          0          0          0
	Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
	10.100.200.1          65004        237        237       0       6       35:03 Establ
	  inet.0: 2/2/2/0




